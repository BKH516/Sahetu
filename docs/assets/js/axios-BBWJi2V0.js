import{a as e}from"./http-vendor-vzM7rUwp.js";import{c as t,g as s}from"./index-Cdudv0m3.js";class r{static instance;attempts=new Map;static getInstance(){return r.instance||(r.instance=new r),r.instance}checkLimit(e,t,s,r=3e5){const o=Date.now(),n=this.attempts.get(e);if(n?.blocked){if(o<n.resetTime)return{allowed:!1,remaining:0,resetTime:n.resetTime,blocked:!0};this.attempts.delete(e)}return!n||o>n.resetTime?(this.attempts.set(e,{count:1,resetTime:o+s,blocked:!1}),{allowed:!0,remaining:t-1,resetTime:o+s,blocked:!1}):n.count>=t?(this.attempts.set(e,{count:n.count,resetTime:o+r,blocked:!0}),{allowed:!1,remaining:0,resetTime:o+r,blocked:!0}):(n.count++,{allowed:!0,remaining:t-n.count,resetTime:n.resetTime,blocked:!1})}checkIPLimit(e,t=10,s=6e4){return this.checkLimit(`ip_${e}`,t,s).allowed}checkUserLimit(e,t=5,s=3e5){return this.checkLimit(`user_${e}`,t,s).allowed}checkEndpointLimit(e,t=100,s=6e4){return this.checkLimit(`endpoint_${e}`,t,s).allowed}getBlockInfo(e){const t=this.attempts.get(e);if(!t)return null;const s=Date.now();return{blocked:t.blocked&&s<t.resetTime,remainingTime:Math.max(0,t.resetTime-s),attempts:t.count}}removeBlock(e){this.attempts.delete(e)}cleanup(){const e=Date.now();for(const[t,s]of this.attempts.entries())e>s.resetTime&&this.attempts.delete(t)}getStats(){const e={ip:{total:0,blocked:0,active:0},user:{total:0,blocked:0,active:0},endpoint:{total:0,blocked:0,active:0}},t=Date.now();for(const[s,r]of this.attempts.entries()){const o=s.split("_")[0];e[o]&&(e[o].total++,r.blocked&&t<r.resetTime?e[o].blocked++:t<r.resetTime&&e[o].active++)}return e}}const o=r.getInstance();if("undefined"!=typeof requestIdleCallback){const e=()=>{requestIdleCallback(()=>{o.cleanup(),setTimeout(e,6e4)},{timeout:5e3})};e()}else setInterval(()=>{document.hidden||o.cleanup()},6e4);const n="https://sahtee.evra-co.com",a="حدث خطأ غير متوقع. حاول مرة أخرى.",i="تعذر الاتصال بالخادم. تحقق من اتصال الانترنت وحاول مرة أخرى.",c="انتهت مهلة الاتصال بالخادم. حاول مجدداً بعد لحظات.",m=e=>{if(!e)return a;if("string"==typeof e)return e;if("object"==typeof e){const t=e;if("string"==typeof t.message)return t.message;if("string"==typeof t.error)return t.error}return a},u=e.create({baseURL:n,timeout:3e4,headers:{"Content-Type":"application/json"},maxRedirects:5,validateStatus:e=>e>=200&&e<300}),d=e.create({baseURL:n,timeout:6e4,headers:{"Content-Type":"application/json"},withCredentials:!1,maxRedirects:5,validateStatus:e=>e>=200&&e<300});u.interceptors.request.use(e=>{const r=e.url||"";if(!o.checkEndpointLimit(r))return Promise.reject(new Error("Rate limit exceeded"));const n=t.getState().token||s();e.headers=e.headers??{},e.headers.Accept=e.headers.Accept??"application/json",n&&!e.headers.Authorization&&(e.headers.Authorization=`Bearer ${n}`);const a=(e.method||"get").toLowerCase(),i=!!e.headers["Content-Type"]||!!e.headers["content-type"],c=e.data;return["post","put","patch"].includes(a)&&!i&&c&&"object"==typeof c&&!(c instanceof FormData)&&!(c instanceof URLSearchParams)&&!(c instanceof Blob)&&(e.headers["Content-Type"]="application/json"),e},e=>Promise.reject(e)),u.interceptors.response.use(e=>e,async e=>{const s=e.config;if("ERR_NETWORK"===e.code||e.message?.includes("ERR_INTERNET_DISCONNECTED"))return Promise.reject({...e,message:i});if("ECONNABORTED"===e.code){if(s&&!s._retry)s._retry=!0,s._retryCount=1;else{if(!(s&&(s._retryCount??0)<3))return Promise.reject({...e,message:c});s._retryCount=(s._retryCount??0)+1}const t=Math.min(1e3*Math.pow(2,(s._retryCount??1)-1),5e3);return await new Promise(e=>setTimeout(e,t)),u(s)}const{response:r}=e;if(!r)return Promise.reject({...e,message:e.message||a});const{status:o,data:n}=r,d=m(n);return 401===o&&t.getState().logout(),403===o&&s&&!s._retry?(s._retry=!0,s._retryCount=1,await new Promise(e=>setTimeout(e,1e3)),u(s)):Promise.reject({...e,message:d,status:o})}),d.interceptors.request.use(e=>{const r=t.getState().token||s();e.headers=e.headers??{},e.headers.Accept=e.headers.Accept??"application/json",r&&!e.headers.Authorization&&(e.headers.Authorization=`Bearer ${r}`);const o=(e.method||"get").toLowerCase(),n=!!e.headers["Content-Type"]||!!e.headers["content-type"],a=e.data;return["post","put","patch"].includes(o)&&!n&&a&&"object"==typeof a&&!(a instanceof FormData)&&!(a instanceof URLSearchParams)&&!(a instanceof Blob)&&(e.headers["Content-Type"]="application/json"),e},e=>Promise.reject(e)),d.interceptors.response.use(e=>(e.status>=200&&e.status<300&&!e.data&&e.config.method,e),async e=>{const s=e.config;if("ERR_NETWORK"===e.code||e.message?.includes("ERR_INTERNET_DISCONNECTED"))return Promise.reject({...e,message:i});if("ECONNABORTED"===e.code){if(s&&!s._retry)s._retry=!0,s._retryCount=1;else{if(!(s&&(s._retryCount??0)<3))return Promise.reject({...e,message:c});s._retryCount=(s._retryCount??0)+1}const t=Math.min(1e3*Math.pow(2,(s._retryCount??1)-1),5e3);return await new Promise(e=>setTimeout(e,t)),d(s)}const{response:r}=e;if(!r)return Promise.reject({...e,message:e.message||a});const{status:o,data:n}=r,u=m(n);return 401===o&&t.getState().logout(),403===o&&s&&!s._retry?(s._retry=!0,s._retryCount=1,await new Promise(e=>setTimeout(e,1e3)),d(s)):Promise.reject({...e,message:u,status:o})});export{d as a,u as b,o as r};
